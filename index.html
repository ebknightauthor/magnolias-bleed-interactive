<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PEACH-BEARER — Dual Perspective Edition</title>
  <!-- Preload the main cover image -->
  <link rel="preload" as="image" href="data:image/webp;base64,UklGRhCoAABXRUJQVlA4IASoAAAQqASdASqEA6AFPpVKoEulpC2qI9KZ4bASC5OQvHq8dW2oGf6W0t1V1b5l2r0pZk1gkZ3nqTQm0Xo8c6fI8v9C8C3qv1JbB6gq8r4fL8mX6G0Q0v7o8mVv3zX6T5lN8b0iO3sS7rCRNw9zq+q0Wg8y5K2u1jKp4q0QZlCwq2C9d3j+0mVb1T1c8O2rQx0W3J0r4R6m7mSx8p8uQ2k8gJZL6A1mYw0l9b7fZxw0w9W9k0k3rKxk2zQyYwVQkH4bYh4O6yI0V2h0w8zKc6iV3P0dR0qYtq8j1kC2mJ2hGd3oWf4c6fJf2H3dH3C5uK2m6Yl3p8m7k8tG20V2w0h3b1w4P2s7Y1m0c3h2v2y2m2y2l3m3q5q5p7o7n9q/8f/8kA">
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
  <style>
    :root { --veil:#0c0a09; --rose:#a11237; --rose2:#9f1239; --line:rgba(255,255,255,.12); }
    html,body { height:100% }
    body { margin:0; background:
        radial-gradient(1200px 700px at 15% 0%, rgba(159,18,57,.12), transparent 60%),
        radial-gradient(900px 600px at 100% 100%, rgba(251,191,36,.08), transparent 60%),
        var(--veil);
      color:#e7e7ea; font-family: "Cormorant Garamond", serif; }
    .title-sub { font-family:"Cinzel", serif }
    .card { background:rgba(0,0,0,.45); border:1px solid var(--line); border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.5) }
    .choice-button { transition:all .3s ease; border:1px solid rgba(220,38,38,.35); background:rgba(10,10,12,.6) }
    .choice-button:hover, .choice-button:focus-visible { transform:translateY(-2px); background:rgba(159,18,57,.7); box-shadow:0 6px 24px rgba(220,38,38,.22); border-color:rgba(220,38,38,.75) }
    .fade { transition: opacity .7s ease-in-out, transform .7s ease-in-out }
    .fade.out { opacity:0; transform: translateY(10px); }
    .pill { font-size:12px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; color:#e5e5e5 }
    .final-cta a { background-color: var(--rose2) } .final-cta a:hover { background-color:#7f0e2d }
    .gate { background: rgba(0,0,0,.85); position: fixed; inset: 0; display: grid; place-items: center; z-index: 50; transition: opacity .5s ease; }
    .whisper { font-style: italic; opacity:.9; border-left:2px solid rgba(255,255,255,.12); padding-left:.75rem; }
    .community-badge, .achievement-toast { transition: opacity .5s ease-in-out, transform .5s ease-in-out; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to { opacity:1; transform:none; } }
    .fade-in { animation: fadeIn 900ms ease both; }
  </style>
</head>
<body class="min-h-screen p-4 flex items-center justify-center">

  <div id="game" class="relative w-full max-w-3xl mx-auto rounded-xl overflow-hidden">
    <!-- Intro -->
    <section id="intro" class="hidden card p-8 md:p-12 text-center fade" aria-labelledby="introTitle">
      <h1 id="introTitle" class="text-4xl md:text-6xl text-white mb-2 title-sub">PEACH-BEARER</h1>
      <p class="text-lg md:text-xl text-rose-200 mb-6 italic">Dual Perspective Edition</p>
      <figure class="max-w-xl mx-auto mb-6 overflow-hidden rounded-lg border border-white/10 shadow">
        <img src="data:image/webp;base64,UklGRhCoAABXRUJQVlA4IASoAAAQqASdASqEA6AFPpVKoEulpC2qI9KZ4bASC5OQvHq8dW2oGf6W0t1V1b5l2r0pZk1gkZ3nqTQm0Xo8c6fI8v9C8C3qv1JbB6gq8r4fL8mX6G0Q0v7o8mVv3zX6T5lN8b0iO3sS7rCRNw9zq+q0Wg8y5K2u1jKp4q0QZlCwq2C9d3j+0mVb1T1c8O2rQx0W3J0r4R6m7mSx8p8uQ2k8gJZL6A1mYw0l9b7fZxw0w9W9k0k3rKxk2zQyYwVQkH4bYh4O6yI0V2h0w8zKc6iV3P0dR0qYtq8j1kC2mJ2hGd3oWf4c6fJf2H3dH3C5uK2m6Yl3p8m7k8tG20V2w0h3b1w4P2s7Y1m0c3h2v2y2m2y2l3m3q5q5p7o7n9q/8f/8kA" alt="Peach-Bearer: Magnolias Bleed cover art, a halved peach bleeding over magnolia blooms" class="w-full h-auto block" />
      </figure>
      <div id="prologue" class="max-w-xl mx-auto opacity-90 mb-8 text-left leading-relaxed fade-in text-base">
        <p><em>They say no code can bury a prophecy written in blood. I have seen the way it stirs beneath the skin, ancient and restless. Two souls move toward each other now, pulled by a gravity older than memory: Mina Sever, who carries the weight of every rebellion her blood remembers, and Malachi King, who hides from his own hunger in circuits and shadows.</em></p>
        <p class="mt-3"><em>When their worlds touch, something wakes. A myth breathes again in the marrow. Here in this Southern city, where folklore tangles with the neon hum of the future, longing and danger are never far apart. Prophecies rise, old orders crumble, and love must decide if it can survive revelation.</em></p>
        <p class="mt-3"><em>Step carefully. Every choice you make bends the path between bondage and freedom, flesh and code, myth and the making of something entirely new.</em></p>
      </div>
      <div class="flex flex-wrap items-center justify-center gap-3">
        <button id="btnNew" class="choice-button text-white font-bold py-3 px-8 rounded-lg text-lg" aria-label="Begin the story">Begin</button>
        <a id="introSubredditLink" href="https://www.reddit.com/r/PlusSizeDarkRomance1/" target="_blank" rel="noopener noreferrer" class="pill bg-neutral-900/60 hover:bg-neutral-800" aria-label="Visit the NSFW subreddit community">NSFW community: r/PlusSizeDarkRomance1</a>
      </div>
    </section>

    <!-- Character Select -->
    <section id="characterSelect" class="hidden card p-8 md:p-12 text-center fade" aria-labelledby="charTitle">
        <h2 id="charTitle" class="text-3xl md:text-4xl text-white mb-4 title-sub">Choose Your Perspective</h2>
        <p class="max-w-xl mx-auto opacity-90 mb-8">Whose story will you uncover?</p>
        <div class="grid md:grid-cols-2 gap-6">
            <button id="btnMina" class="choice-button text-white font-bold p-6 rounded-lg text-lg flex flex-col items-center" aria-label="Play as Mina Sever">
                <span class="text-2xl mb-2">Mina Sever</span>
                <span class="text-sm font-normal opacity-80">The Oath, the City, the Choice.</span>
            </button>
            <button id="btnMalachi" class="choice-button text-white font-bold p-6 rounded-lg text-lg flex flex-col items-center" aria-label="Play as Malachi King">
                <span class="text-2xl mb-2">Malachi King</span>
                <span class="text-sm font-normal opacity-80">The Name, the Power, the Woman.</span>
            </button>
        </div>
    </section>

    <!-- Content -->
    <section id="play" class="hidden card p-8 md:p-12 relative fade" aria-live="polite" aria-labelledby="storyTitle">
      <div id="communityBadge" class="community-badge absolute top-4 left-4 bg-rose-800/80 text-white text-xs font-bold px-3 py-1 rounded-full title-sub tracking-wider opacity-0">COMMUNITY</div>
      <div id="partIndicator" class="absolute top-4 right-4 bg-neutral-800/80 text-white text-xs font-bold px-3 py-1 rounded-full title-sub tracking-wider"></div>
      <div class="absolute -top-3 right-0 left-0 flex justify-end pr-2 gap-2">
        <button id="btnSettings" class="pill bg-neutral-900/60" aria-haspopup="dialog">Settings</button>
      </div>
      <h2 id="storyTitle" class="sr-only">Story</h2>
      <div id="story" class="text-lg md:text-xl leading-relaxed mb-6 min-h-[150px] fade"></div>
      <div id="whisper" class="whisper text-sm mb-6 hidden" aria-live="polite"></div>
      <div id="choices" class="grid grid-cols-1 gap-4 fade" role="list"></div>
    </section>

    <!-- End Screen -->
    <section id="endScreen" class="hidden card p-8 md:p-12 text-center fade" aria-labelledby="endTitle">
        <h2 id="endTitle" class="text-3xl md:text-4xl text-white mb-4 title-sub"></h2>
        <p id="endText" class="max-w-xl mx-auto opacity-90 mb-8 text-lg"></p>
        <div class="final-cta">
            <a href="http://books.apple.com/us/book/id6749192930" target="_blank" rel="noopener noreferrer" class="inline-block choice-button text-white font-bold py-4 px-10 rounded-lg text-xl">
                Read the Full Story on Apple Books
            </a>
        </div>
        <div id="endSubredditBox" class="mt-6 text-left mx-auto max-w-xl p-4 rounded-lg border border-white/10 bg-neutral-900/50">
          <h3 class="title-sub text-xl mb-1">Join the NSFW subreddit community</h3>
          <p class="text-sm opacity-90 mb-3">r/PlusSizeDarkRomance1 is a space for readers, writers, and lurkers who crave dark romance with plus-size main characters. Expect recs, author promos with flair, spicy art, and talk of possessive antiheroes and morally gray lovers.</p>
          <a href="https://www.reddit.com/r/PlusSizeDarkRomance1/" target="_blank" rel="noopener noreferrer" class="pill inline-block bg-neutral-900/60 hover:bg-neutral-800">Visit r/PlusSizeDarkRomance1</a>
        </div>
         <button id="btnRestart" class="mt-6 bg-neutral-900/80 hover:bg-neutral-800 text-white font-bold py-2 px-6 rounded-lg text-md border border-white/10">Play Again</button>
    </section>
  </div>

  <!-- Gate -->
  <div id="gate" class="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle" aria-describedby="gateDesc">
    <div class="w-full max-w-md mx-auto p-6 rounded-xl border border-white/10 bg-neutral-900/80 backdrop-blur-sm">
      <h2 id="gateTitle" class="title-sub text-2xl mb-2">Before you enter</h2>
      <p id="gateDesc" class="text-sm opacity-90 mb-4">This story is for adults and uses suggestive themes. Please confirm you are 18 or older to continue.</p>
      <label class="flex items-center gap-2 mb-3">
        <input id="consent" type="checkbox" class="h-4 w-4" /> <span>I am 18+ and I consent</span>
      </label>
      <div class="mt-4">
        <label class="block text-sm mb-1" for="spice">Spice Level (can be changed later)</label>
        <input id="spice" type="range" min="0" max="2" step="1" value="1" class="w-full" />
        <div class="mt-1"><span id="spiceLabel" class="pill">Warm</span></div>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button id="gateEnter" class="choice-button px-4 py-2 rounded-lg bg-rose-700 hover:bg-rose-600 disabled:opacity-50" disabled>Enter</button>
      </div>
    </div>
  </div>
  
  <!-- Achievement Toast -->
  <div id="achievementToast" class="achievement-toast fixed bottom-5 right-5 bg-neutral-800 border border-amber-400/50 text-white p-4 rounded-lg shadow-lg opacity-0 transform translate-y-3 pointer-events-none">
    <div class="flex items-center">
      <div class="text-amber-400 mr-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15s-2 6-6 6-6-6-6-6"/><path d="M12 15V3"/><path d="m5 8 7 7 7-7"/></svg>
      </div>
      <div>
        <h3 class="font-bold title-sub">Perspectives Unlocked!</h3>
        <p class="text-sm opacity-90">You've seen both sides. Join the community to discuss!</p>
      </div>
    </div>
  </div>

  <script>
    const EL = (id) => document.getElementById(id);
    const SAVE_KEY_PREFIX = "pb_dual_perspective_v3"; // Updated key for new story

    const CANON = {
      people: ["Mina Sever","Malachi King","Mama Sage","Commissioner Vasquez", "Niko Sever"],
      places: ["Portico Nine","Project Cotton Bloom", "The Conservatory", "Riverpoint Estate", "Kranj"],
      quotes: {
          mina: ["A King's heart is a gilded cage, child.", "The magnolias remember what the city pretends to forget.", "Every leash transmits data both ways."],
          malachi: ["Power is a current, not a crown.", "Some debts are paid in blood, others in loyalty.", "Scarcity will starve on her Balkan flesh."]
      },
      protagonist:"Mina Sever",
      interest:"Malachi King",
      mentor:"Mama Sage",
      antagonist:"Commissioner Vasquez",
    };

    let gameState = { character: null, currentNode: null };

    // UI Elements
    const intro = EL("intro"), play = EL("play"), characterSelect = EL("characterSelect"), endScreen = EL("endScreen");
    const storyBox = EL("story"), whisperBox = EL("whisper"), choicesBox = EL("choices"), endText = EL("endText"), endTitle = EL("endTitle");
    const btnNew = EL("btnNew"), btnMina = EL("btnMina"), btnMalachi = EL("btnMalachi"), btnRestart = EL("btnRestart");
    const gate = EL("gate"), consent = EL("consent"), spice = EL("spice"), spiceLabel = EL("spiceLabel"), btnSettings = EL("btnSettings"), gateEnter = EL("gateEnter");
    const introSubredditLink = EL("introSubredditLink"), endSubredditBox = EL("endSubredditBox");
    const partIndicator = EL("partIndicator");

    const getSpice = () => Number(localStorage.getItem(`${SAVE_KEY_PREFIX}_spice`) || 1);
    const labelForSpice = (v) => ["Soft","Warm","Hot"][Number(v)||1];

    function makeStory(character) {
        const N = CANON;
        if (character === 'mina') {
            return {
                // PART I: ROOTS & DEBTS
                start: { 
                    part: "Part I: Roots & Debts",
                    text: `The summons arrives not as a letter, but as a ghost. A scent of peaches and iron in your small Kranj flat. Your brother, Niko, has defaulted on a debt, and the collateral clause has been triggered. You are the collateral. You are being delivered to a mansion in America.`,
                    choices: [ 
                        { text: `Fight. Refuse to go.`, node: "part1_refuse" }, 
                        { text: `Go. To save your brother.`, node: "part1_go" } 
                    ] 
                },
                part1_refuse: {
                    part: "Part I: Roots & Debts",
                    text: `You burn the papers. But the prophecy doesn't need your permission. Two men arrive. They don't speak. They simply escort you to a waiting car. Your choice was an illusion.`,
                    choices: [ { text: `You arrive at the mansion.`, node: "part1_arrive" } ]
                },
                part1_go: { 
                    part: "Part I: Roots & Debts",
                    text: `You pack a single bag, your heart a cold stone in your chest. The flight is a blur. You arrive at a mansion built on blood-soaked cotton and humming servers. This is your cage.`, 
                    choices: [ { text: `You are brought before him.`, node: "part1_arrive" } ] 
                },
                part1_arrive: {
                    part: "Part I: Roots & Debts",
                    text: `He stands in the grand foyer. Malachi King. Taller than you imagined. "Welcome home, Peach," he says, his voice layered with the hum of servers and the whisper of cotton fields.`,
                    choices: [
                        { text: `"I am not your Peach."`, node: "part2_defy" },
                        { text: `Say nothing. Endure.`, node: "part2_endure" }
                    ]
                },
                // PART II: THE CLAIMING
                part2_defy: {
                    part: "Part II: The Claiming",
                    text: `A slow, dangerous smile. "You are whatever the contract says you are. And the contract is 150 years old." He gestures, and holographic displays fill the air, showing Gullah prophecies and your own genetic markers. "Your body will become an altar."`,
                    choices: [
                        { text: "This is madness.", node: "part2_madness" },
                        { text: "What do you want from me?", node: "part2_what_want" }
                    ]
                },
                part2_endure: {
                    part: "Part II: The Claiming",
                    text: `Your silence is a different kind of defiance. He studies you. "The field is hungry," he says. "And you, Mina Sever, are the feast. Your body will bloom in ways you cannot imagine. You will become a weapon."`,
                    choices: [
                        { text: "A weapon against who?", node: "part2_what_want" },
                        { text: "You're insane.", node: "part2_madness" }
                    ]
                },
                part2_madness: {
                    part: "Part II: The Claiming",
                    text: `He laughs. "Is it madness to answer a call that has echoed through your bloodline for generations? The binding is real. The power is real. And soon, so will be your transformation."`,
                    choices: [
                        { text: "Accept this fate.", node: "part3_accept" },
                        { text: "Find a way to fight.", node: "part3_fight" }
                    ]
                },
                part2_what_want: {
                    part: "Part II: The Claiming",
                    text: `His expression turns serious. "I want to awaken the power sleeping in this land. A power that men like Commissioner Vasquez want to control or destroy. Your body is the catalyst. You will help me protect it, and in doing so, you will discover a power you never knew you possessed."`,
                    choices: [
                        { text: "I will be your weapon.", node: "part3_accept" },
                        { text: "I will find my own power.", node: "part3_fight" }
                    ]
                },
                // PART III: TRANSFORMATION
                part3_accept: {
                    part: "Part III: Transformation",
                    text: `You begin to lean into the transformation. The changes to your body are terrifying, but they bring a strange new power. You feel the house responding to your moods, the cotton in the conservatory blooming when you are near. You are becoming something more than human.`,
                    choices: [
                        { text: "Embrace him as your partner.", node: "end_happy" },
                        { text: "Use your new power to escape.", node: "end_mina_escape" }
                    ]
                },
                part3_fight: {
                    part: "Part III: Transformation",
                    text: `You resist. You search for weaknesses in his digital empire, a way to contact the outside world. You find a sympathetic ear in Commissioner Vasquez, who sees you as a victim to be rescued. You begin feeding her information, a dangerous double game.`,
                    choices: [
                        { text: "Betray him completely.", node: "end_mina_betray" },
                        { text: "Have a change of heart.", node: "end_happy" }
                    ]
                },
                // ENDINGS
                end_happy: {
                    title: "Epilogue: Blood Magnolias",
                    text: "You chose him. Together, you weather the storm. The empire falls, but something new rises from its ashes. In a quiet corner of the South Carolina Low Country, your child is born, a bridge between worlds. You have found a love that transcends captivity, and a power that will reshape the future.",
                    isEnd: true
                },
                end_mina_betray: {
                    title: "The Gilded Cage",
                    text: `Your betrayal is absolute. With the information you provide, Commissioner Vasquez raids the mansion. Malachi is arrested, his empire dismantled. The world sees you as a victim, rescued from a monster. But as you testify against him, you learn Niko died of an overdose weeks ago, his life the price of your 'freedom'. You are safe, but you are alone, haunted by the ghost of a power you chose to destroy.`,
                    isEnd: true
                },
                end_mina_escape: {
                    title: "The Lone Goddess",
                    text: `You master the supernatural forces blooming within you. You don't need Malachi or Vasquez. You are a power unto yourself. You destroy the mansion's servers, escape into the world, and disappear. You are a goddess without a worshipper, a queen without a kingdom, forever hunted by those who fear what you've become.`,
                    isEnd: true
                }
            };
        } else if (character === 'malachi') {
            return {
                // PART I: ROOTS & DEBTS
                start: { 
                    part: "Part I: Roots & Debts",
                    text: `For seventeen years, you have fed your empire—and your obsession—with data scraped from one woman. Now, the prophecy awakens. The collateral clause is triggered. The Peach-Bearer is finally being delivered to your door.`, 
                    choices: [ 
                        { text: `Prepare the mansion for her arrival.`, node: "part1_prepare" }, 
                        { text: `Review the final surveillance data.`, node: "part1_review" } 
                    ] 
                },
                part1_review: {
                    part: "Part I: Roots & Debts",
                    text: `You watch the final feeds from her Kranj flat. Her fear, her defiance, her scent... it's all data, and it's all perfect. The Gullah binding from 1858 is resonating with her genetic markers. She is ripe. The field is hungry.`,
                    choices: [ { text: "She is on her way.", node: "part1_prepare" } ]
                },
                part1_prepare: {
                    part: "Part I: Roots & Debts",
                    text: `The mansion hums to life. Servers spin, environmental controls adjust to mimic a Low Country summer, and the dormant cotton plants in the conservatory stir. Everything is ready for the claiming. Everything is ready for Project Cotton Bloom.`,
                    choices: [ { text: `She arrives.`, node: "part2_arrive" } ]
                },
                // PART II: THE CLAIMING
                part2_arrive: {
                    part: "Part II: The Claiming",
                    text: `She stands before you in the foyer. More magnificent in person than any data point could capture. Her fear is a perfume. Her defiance, an aphrodisiac. "Welcome home, Peach," you say.`,
                    choices: [
                        { text: `She defies you. "I am not your Peach."`, node: "part2_defies" },
                        { text: `She is silent. A challenge in itself.`, node: "part2_is_silent" }
                    ]
                },
                part2_defies: {
                    part: "Part II: The Claiming",
                    text: `Her fire is exactly what the prophecy requires. "You are whatever the contract says you are," you tell her. "Your body will become an altar for Project Cotton Bloom." You must decide how to handle her defiance.`,
                    choices: [
                        { text: "Explain the stakes. Try to win her over.", node: "part3_explain" },
                        { text: "Assert your control. Break her will.", node: "part3_assert_control" }
                    ]
                },
                part2_is_silent: {
                    part: "Part II: The Claiming",
                    text: `You let her silence hang in the air. "The field is hungry," you say. "And you, Mina Sever, are the feast. Your body will bloom in ways you cannot imagine." You must choose your next move.`,
                    choices: [
                        { text: "Reveal the true mission. Make her an ally.", node: "part3_explain" },
                        { text: "Begin the indoctrination. She is a vessel.", node: "part3_assert_control" }
                    ]
                },
                // PART III: TRANSFORMATION
                part3_explain: {
                    part: "Part III: Transformation",
                    text: `You reveal the true threat: Commissioner Vasquez, who sees your power as a threat to be neutralized. You position yourself not as a captor, but as a protector. You offer Mina a partnership. Her reaction is uncertain, but she seems to be listening.`,
                    choices: [
                        { text: "Trust her. Give her more autonomy.", node: "end_happy" },
                        { text: "Your obsession makes you careless. You miss Vasquez's real threat.", node: "end_malachi_exposed" }
                    ]
                },
                part3_assert_control: {
                    part: "Part III: Transformation",
                    text: `You let the mask of the CEO drop, revealing the predator. You use the mansion's systems to begin her indoctrination, a psychological campaign to break her will and reshape her into the perfect vessel. She fights you at every turn, a beautiful, caged animal.`,
                    choices: [
                        { text: "Your cruelty pushes her away, into Vasquez's arms.", node: "end_malachi_exposed" },
                        { text: "Your absolute control works. She breaks, and you remake her.", node: "end_malachi_vessel" }
                    ]
                },
                 // ENDINGS
                end_happy: {
                    title: "Epilogue: Blood Magnolias",
                    text: "You chose her. Together, you weather the storm. The empire falls, but something new rises from its ashes. In a quiet corner of the South Carolina Low Country, your child is born, a bridge between worlds. You have found a love that transcends captivity, and a power that will reshape the future.",
                    isEnd: true
                },
                end_malachi_exposed: { 
                    title: "Empire of Ash",
                    text: "Your obsession with Mina makes you careless. Whether through her betrayal or your own arrogance, you underestimate Commissioner Vasquez. She gathers enough evidence to expose Project Cotton Bloom to the world. Your empire collapses, and you are branded a monster—the man who kidnapped a 'fat white woman' to be his 'milk dairy cow and breeding vessel'. You lose everything.", 
                    isEnd: true 
                },
                end_malachi_vessel: { 
                    title: "The Bitter Harvest",
                    text: "You succeed. Mina's will is broken, and she becomes the perfect, docile vessel for the prophecy. The transformation is a success, and the power you unlock is immense. But the woman you were obsessed with is gone, replaced by an empty shell. You have your goddess, but you have lost her soul. You are a king alone on a throne of empty victory.", 
                    isEnd: true 
                }
            };
        }
    }

    let STORY;

    function transition(hideEl, showEl, callback) {
        hideEl.classList.add('out');
        setTimeout(() => {
            hideEl.classList.add('hidden');
            hideEl.classList.remove('out');
            showEl.classList.remove('hidden');
            if (callback) callback();
            const firstButton = showEl.querySelector('button, [href], input, select, textarea');
            if (firstButton) firstButton.focus();
        }, 700);
    }

    function showCommunityBadge() {
        const badge = EL('communityBadge');
        if (badge) { // Error check
            badge.style.opacity = '1';
            setTimeout(() => { badge.style.opacity = '0'; }, 5000);
        }
    }
    
    function showAchievementToast() {
        const toast = EL('achievementToast');
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(0.75rem)';
        }, 6000);
    }

    function showNode(name) {
      const node = STORY[name];
      if (!node) { console.error("Node not found:", name); return; }

      gameState.currentNode = name;
      localStorage.setItem(`${SAVE_KEY_PREFIX}_character`, gameState.character);
      localStorage.setItem(`${SAVE_KEY_PREFIX}_node`, name);

      if (node.isEnd) {
          localStorage.setItem(`${SAVE_KEY_PREFIX}_${gameState.character}_complete`, 'true');
          const minaComplete = localStorage.getItem(`${SAVE_KEY_PREFIX}_mina_complete`) === 'true';
          const malachiComplete = localStorage.getItem(`${SAVE_KEY_PREFIX}_malachi_complete`) === 'true';
          const achievementShown = localStorage.getItem(`${SAVE_KEY_PREFIX}_achievement_shown`) === 'true';

          if (minaComplete && malachiComplete && !achievementShown) {
              showAchievementToast();
              localStorage.setItem(`${SAVE_KEY_PREFIX}_achievement_shown`, 'true');
          }
          showEndScreen(node);
          return;
      }

      partIndicator.textContent = node.part || "";
      storyBox.classList.add("out");
      choicesBox.classList.add("out");
      setTimeout(() => {
        storyBox.textContent = node.text;
        choicesBox.innerHTML = "";

        const quotes = CANON.quotes[gameState.character] || [];
        if (quotes.length > 0){
            const idx = Math.floor(Math.random() * quotes.length);
            whisperBox.textContent = `"${quotes[idx]}"`;
            whisperBox.classList.remove("hidden");
        } else {
            whisperBox.classList.add("hidden");
        }

        node.choices.forEach((c) => {
          const b = document.createElement("button");
          b.className = "choice-button text-white font-bold py-4 px-6 rounded-lg w-full text-left text-lg";
          b.setAttribute('role','listitem');
          b.textContent = c.text;
          b.onclick = () => showNode(c.node);
          choicesBox.appendChild(b);
        });
        storyBox.classList.remove("out");
        choicesBox.classList.remove("out");
        const first = choicesBox.querySelector('button');
        if (first) first.focus();
      }, 500);
    }

    function showEndScreen(node) {
        endTitle.textContent = node.title || "The Story Continues";
        endText.textContent = node.text;
        // The happy ending for Malachi is Mina's happy ending.
        if(gameState.character === 'malachi' && node.isEnd && !node.title){
            const happyNode = STORY['end_happy'];
            endTitle.textContent = happyNode.title;
            endText.textContent = happyNode.text;
        }
        transition(play, endScreen);
    }

    function startGame() {
        STORY = makeStory(gameState.character);
        transition(characterSelect, play, () => {
            showCommunityBadge();
            showNode('start');
        });
    }

    function resetGame() {
        localStorage.removeItem(`${SAVE_KEY_PREFIX}_node`);
        localStorage.removeItem(`${SAVE_KEY_PREFIX}_character`);
        transition(endScreen, intro);
    }

    function toggleSubredditLinks(isConsented) {
        introSubredditLink.classList.toggle('hidden', !isConsented);
        endSubredditBox.classList.toggle('hidden', !isConsented);
    }
    
    function handleConsent() {
        const isConsented = consent.checked;
        if (isConsented) {
            localStorage.setItem(`${SAVE_KEY_PREFIX}_consent`, "1");
            localStorage.setItem(`${SAVE_KEY_PREFIX}_spice`, String(Number(spice.value||1)));
            gate.style.opacity = '0';
            setTimeout(() => {
                gate.style.display = 'none';
                intro.classList.remove('hidden');
                intro.querySelector('button').focus();
            }, 500);
        }
        toggleSubredditLinks(isConsented);
    }

    btnNew.addEventListener("click", () => transition(intro, characterSelect));
    btnMina.addEventListener("click", () => { gameState.character = 'mina'; startGame(); });
    btnMalachi.addEventListener("click", () => { gameState.character = 'malachi'; startGame(); });
    btnRestart.addEventListener("click", resetGame);
    
    // Gate and settings logic
    let lastFocusedBeforeSettings = null;
    function openSettings(){
        lastFocusedBeforeSettings = document.activeElement;
        gate.querySelector('#gateTitle').textContent = 'Settings';
        gate.querySelector('#gateDesc').textContent = 'Adjust your experience.';
        gate.querySelector('#gateEnter').textContent = 'Done';
        gate.style.display = 'grid';
        setTimeout(()=> gate.style.opacity = '1', 10);
        gate.querySelector('#consent').focus();
    }

    btnSettings.addEventListener("click", openSettings);
    gateEnter.addEventListener("click", handleConsent);
    consent.addEventListener("change", ()=> { gateEnter.disabled = !consent.checked; });
    spice.addEventListener("input", ()=> { spiceLabel.textContent = labelForSpice(spice.value); });
    document.addEventListener('keydown', (e)=>{ if (gate.style.display === 'grid' && e.key === 'Escape') handleConsent(); });

    (function init(){
      const isConsented = !!localStorage.getItem(`${SAVE_KEY_PREFIX}_consent`);
      toggleSubredditLinks(isConsented);
      
      if (!isConsented) {
          intro.classList.add('hidden');
          gate.style.display = 'grid';
      } else {
          gate.style.display = 'none';
          intro.classList.remove('hidden');
      }

      const savedChar = localStorage.getItem(`${SAVE_KEY_PREFIX}_character`);
      const savedNode = localStorage.getItem(`${SAVE_KEY_PREFIX}_node`);
      if (isConsented && savedChar && savedNode) {
        const storyForChar = makeStory(savedChar);
        if(storyForChar[savedNode] && !storyForChar[savedNode].isEnd) {
            gameState.character = savedChar;
            STORY = storyForChar;
            intro.classList.add('hidden');
            play.classList.remove('hidden');
            showNode(savedNode);
        }
      }
    })();
  </script>
</body>
</html>
